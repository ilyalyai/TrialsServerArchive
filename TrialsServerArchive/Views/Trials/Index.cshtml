@model IPagedList<TrialsServerArchive.Models.Objects.TrialObject>
@using X.PagedList.Mvc.Core;
@using TrialsServerArchive.Models.Objects;
@inject SignInManager<ApplicationUser> SignInManager

@{
    ViewData["Title"] = "Журнал образцов";
    var standardAges = new[] { 2, 7, 9, 28, 90, 180, 360 };
}

<style>
    .trial-table {
        font-size: 0.85rem;
    }

    .highlight-row {
        border: 2px solid #ff0000 !important;
        animation: pulse 2s infinite;
    }

    .age-cell {
        text-align: center;
        font-weight: bold;
        min-width: 30px;
        padding: 3px !important;
    }

    .results-group {
        background-color: #f0f8ff;
    }

    .age-group {
        background-color: #fff0f5;
    }

    .checkbox-cell {
        width: 30px;
        text-align: center;
    }

    .group-header {
        background-color: #e9ecef;
        font-weight: bold;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .actions-cell {
        width: 120px;
    }

    @@keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(255,0,0,0.4);
        }

        70% {
            box-shadow: 0 0 0 10px rgba(255,0,0,0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(255,0,0,0);
        }
    }
</style>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>@ViewData["Title"]</h1>
        <button id="moveToJournalBtn" class="btn btn-primary" disabled>
            <i class="bi bi-journal-plus"></i> Занести в журнал
        </button>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover trial-table">
                    <thead class="table-light">
                        <tr>
                            <th class="checkbox-cell">
                                <input type="checkbox" id="selectAll">
                            </th>
                            <!-- Общие параметры -->
                            <th>ID</th>
                            <th>Образец</th>
                            <th>Дата исп.</th>
                            <th>Режим</th>
                            <th>Печь/прог.</th>
                            <th>Место хр.</th>

                            <!-- Нормативный возраст -->
                            @foreach (var age in standardAges)
                            {
                                <th class="age-cell">@age</th>
                            }

                            <!-- Результаты испытаний -->
                            <th>Вес, г</th>
                            <th>a, мм</th>
                            <th>b, мм</th>
                            <th>h, мм</th>
                            <th>Плотн.</th>
                            <th>Потери</th>
                            <th>Нагрузка</th>
                            <th>МК</th>
                            <th>Прочность</th>
                            <th>Темп.</th>
                            <th>Влажн.</th>
                            <th>МУ</th>
                            <th>МУ*</th>
                            <th>ПП</th>
                            <th>Испытал</th>
                            <th>Прим.</th>
                            <th class="actions-cell">Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var seriesGroup in Model.GroupBy(t => t.SeriesName).OrderBy(g => g.Key))
                        {
                            <tr class="group-header">
                                <td colspan="26">
                                    <strong>Серия: @(seriesGroup.Key ?? "Без серии")</strong>
                                    @if (!string.IsNullOrEmpty(seriesGroup.Key))
                                    {
                                        <form asp-action="RemoveSeries" method="post" class="d-inline float-end">
                                            <input type="hidden" name="seriesName" value="@seriesGroup.Key" />
                                            <button type="submit" class="btn btn-sm btn-outline-danger ms-2">
                                                <i class="bi bi-x-circle"></i> Разгруппировать
                                            </button>
                                        </form>
                                    }
                                </td>
                            </tr>

                            @foreach (var trial in seriesGroup)
                            {
                                <tr data-id="@trial.Id" class="@(trial.DaysToNextAge <= 3 ? "highlight-row" : "")">
                                    <td class="checkbox-cell">
                                        <input type="checkbox" class="trial-checkbox" data-id="@trial.Id">
                                    </td>
                                    <!-- Общие параметры -->
                                    <td>@trial.Id</td>
                                    <td>@(trial.Name ?? "N/A")</td>
                                    <td>@trial.TestingDate.ToString("dd.MM.yy")</td>
                                    <td>@trial.TestMode</td>
                                    <td>@(trial.FurnaceProgram?.Name ?? "-")</td>
                                    <td>@(trial.StoragePlace?.Name ?? "-")</td>

                                    <!-- Нормативный возраст -->
                                    @foreach (var age in standardAges)
                                    {
                                        <td class="age-cell">
                                            @if (trial.TestingAge >= age)
                                            {
                                                @age
                                            }
                                        </td>
                                    }

                                    <!-- Результаты испытаний -->
                                    <td>@trial.WeightAfterTest?.ToString("F1")</td>
                                    <td>@trial.DimensionAAfterTest?.ToString("F1")</td>
                                    <td>@trial.DimensionBAfterTest?.ToString("F1")</td>
                                    <td>@trial.DimensionCAfterTest?.ToString("F1")</td>
                                    <td>@trial.Density.ToString("F0")</td>
                                    <td>@trial.DensityLoss?.ToString("F0")</td>
                                    <td>@trial.BreakingLoad?.ToString("F2")</td>
                                    <td>@trial.WetCoefficient?.ToString("F2")</td>
                                    <td>@trial.StrengthWithCoefficient?.ToString("F2")</td>
                                    <td>@trial.TestingTemperature?.ToString("F1")</td>
                                    <td>@trial.TestingHumidity?.ToString("F1")</td>
                                    <td>@trial.MU</td>
                                    <td>@trial.MUStar</td>
                                    <td>@trial.PP</td>
                                    <td>@trial.TestedBy</td>
                                    <td>@trial.Comment</td>
                                    <td>
                                        <a asp-action="Edit" asp-route-id="@trial.Id" class="btn btn-sm btn-primary">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <form asp-action="Delete" method="post" class="d-inline">
                                            <input type="hidden" name="id" value="@trial.Id" />
                                            <button type="submit" class="btn btn-sm btn-danger"
                                                    onclick="return confirm('Удалить образец полностью?')">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>

                <!-- Пагинация -->
                <div class="d-flex justify-content-center">
                    @Html.PagedListPager(Model, page => Url.Action("Index", new { page }),
                             new PagedListRenderOptions
                    {
                        LiElementClasses = new[] { "page-item" },
                        PageClasses = new[] { "page-link" },
                        DisplayLinkToFirstPage = PagedListDisplayMode.IfNeeded,
                        DisplayLinkToLastPage = PagedListDisplayMode.IfNeeded
                    })
                </div>
            </div>
        </div>
    </div>
</div>

@if (SignInManager.IsSignedIn(User))
{
    <!-- Модальное окно перевода в журнал -->
    <div class="modal fade" id="journalModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form asp-action="MoveToJournal" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title">Перевод в журнал</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="ids" id="journalIds">
                        <p>Вы уверены, что хотите переместить выбранные образцы в журнал?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button type="submit" class="btn btn-primary">Подтвердить</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        $(function () {
            // Подсветка строк, требующих внимания
            function updateHighlighting() {
                $('tr[data-id]').each(function () {
                    const daysToNext = $(this).data('days-to-next');
                    if (daysToNext !== undefined && daysToNext <= 3) {
                        $(this).addClass('highlight-row');
                    } else {
                        $(this).removeClass('highlight-row');
                    }
                });
            }

            // Обновляем каждую минуту
            setInterval(updateHighlighting, 60000);
            updateHighlighting();

            // Выбор всех/снятие всех чекбоксов
            $('#selectAll').change(function () {
                $('.trial-checkbox').prop('checked', this.checked);
                updateButtons();
            });

            // Обновление состояния кнопок
            $('.trial-checkbox').change(updateButtons);

            function updateButtons() {
                const checkedCount = $('.trial-checkbox:checked').length;
                $('#moveToJournalBtn').prop('disabled', checkedCount === 0);
            }

            // Открытие модалки перевода в журнал
            $('#moveToJournalBtn').click(function () {
                const ids = $('.trial-checkbox:checked').map(function () {
                    return $(this).data('id');
                }).get();

                if (ids.length === 0) return;

                $('#journalIds').val(ids.join(','));
                $('#journalModal').modal('show');
            });
        });
    </script>
}